services:
  traefik:
    image: traefik:v3.1
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - traefik
    ports:
      - 80:80
      - 443:443
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./conf:/traefik
      - ./volumes/cert:/cert
      - ./volumes/log:/log
    environment:
      TZ: Europe/Berlin
      LEGO_DISABLE_CNAME_SUPPORT: true
      PORKBUN_SECRET_API_KEY: ${PORKBUN_SECRET_API_KEY}
      PORKBUN_API_KEY: ${PORKBUN_API_KEY}
      GANDIV5_API_KEY: ${GANDIV5_API_KEY}
      BASIC_AUTH_USER: ${BASIC_AUTH_USER}
      BASIC_AUTH_PASSWORD: ${BASIC_AUTH_PASSWORD}
    command:
      - "--configFile=/traefik/traefik.yaml"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.splitbrain.net`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik.middlewares=basicauth@file"

  whoami:
    image: traefik/whoami:latest
    container_name: whoami
    restart: unless-stopped
    command:
      - "--verbose"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami.rule=Host(`whoami.splitbrain.net`)"
      - "traefik.http.routers.whoami.tls.certresolver=letsencrypt"
    networks:
      - traefik

  goaccess:
    image: allinurl/goaccess
    restart: always
    command: > 
      /srv/logs/access.log
      -o /srv/report/index.html
      --real-time-html
      --origin=https://goaccess.splitbrain.net
      --ws-url=wss://goaccess.splitbrain.net:443/live
      --log-format='%h %^[%d:%t %^] "%r" %s %b %R %u %^ %v %^ %Lms'
      --time-format='%H:%M:%S'
      --date-format='%d/%b/%Y'
      --db-path=/srv/data
      --persist
      --restore
    volumes:
      - ./volumes/log:/srv/logs:ro
      - ./volumes/web:/srv/report
      - ./volumes/goaccess:/srv/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.goaccess.rule=Host(`goaccess.splitbrain.net`) && Path(`/live`)"
      - "traefik.http.routers.goaccess.tls.certresolver=letsencrypt"
    networks:
      - traefik

  goaccess-web:
    image: joseluisq/static-web-server:2-alpine
    restart: unless-stopped
    volumes:
      - ./volumes/web:/public
    environment:
      SERVER_IGNORE_HIDDEN_FILES: true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.goaccess-web.rule=Host(`goaccess.splitbrain.net`)"
      - "traefik.http.routers.goaccess-web.tls.certresolver=letsencrypt"
    networks:
      - traefik

networks:
  traefik:
    name: traefik
